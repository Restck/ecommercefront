<mat-card class="cliente-pedidos-card">
  <h2 class="titulo-pedidos">Pedidos del Cliente</h2>

  <!-- Buscador -->
  <mat-form-field appearance="outline" class="buscador">
    <mat-label>Buscar</mat-label>
    <input
      matInput
      [(ngModel)]="searchText"
      (input)="filtrarPedidos()"
      placeholder="Buscar por estado o ciudad"
    />
    <button
      mat-icon-button
      matSuffix
      *ngIf="searchText"
      (click)="searchText=''; filtrarPedidos()"
    >
      <mat-icon>close</mat-icon>
    </button>
  </mat-form-field>

  <!-- Tabla -->
  <div *ngIf="pagedPedidos.length > 0; else sinPedidos" class="tabla-wrapper">
    <table mat-table [dataSource]="pagedPedidos" class="mat-elevation-z8 tabla-pedidos">

      <!-- Fecha -->
      <ng-container matColumnDef="fecha">
        <th mat-header-cell *matHeaderCellDef>Fecha</th>
        <td mat-cell *matCellDef="let pedido">{{ pedido.fecha | date: 'short' }}</td>
      </ng-container>

      <!-- Total -->
      <ng-container matColumnDef="total">
        <th mat-header-cell *matHeaderCellDef>Total</th>
        <td mat-cell *matCellDef="let pedido">${{ pedido.total | number: '1.0-0' }}</td>
      </ng-container>

      <!-- Estado del pedido -->
      <ng-container matColumnDef="estado">
        <th mat-header-cell *matHeaderCellDef>Estado del pedido</th>
        <td mat-cell *matCellDef="let pedido">
          <mat-form-field appearance="fill">
            <mat-select [(ngModel)]="pedido.estado">
              <mat-option *ngFor="let e of estadosPedido" [value]="e">
                {{ e | titlecase }}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </td>
      </ng-container>

      <!-- Estado del comprobante -->
      <ng-container matColumnDef="estadoComprobante">
        <th mat-header-cell *matHeaderCellDef>Estado del comprobante</th>
        <td mat-cell *matCellDef="let pedido">
          <mat-form-field appearance="fill">
            <mat-select [(ngModel)]="pedido.estadoComprobante">
              <mat-option *ngFor="let e of estadosComprobante" [value]="e">
                {{ e | titlecase }}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </td>
      </ng-container>

      <!-- Comprobante -->
      <ng-container matColumnDef="comprobante">
        <th mat-header-cell *matHeaderCellDef>Comprobante</th>
        <td mat-cell *matCellDef="let pedido">
          <ng-container *ngIf="pedido.comprobante; else noComprobante">
            <img
              [src]="getComprobanteUrl(pedido)"
              alt="Comprobante"
              class="comprobante-img"
              width="40"
              style="cursor: pointer; border-radius: 4px;"
              (click)="abrirComprobante(pedido)"
            />
          </ng-container>

          <ng-template #noComprobante>
            <span class="text-muted">Sin comprobante</span>
          </ng-template>
        </td>
      </ng-container>

      <!-- Ciudad -->
      <ng-container matColumnDef="ciudad">
        <th mat-header-cell *matHeaderCellDef>Ciudad</th>
        <td mat-cell *matCellDef="let pedido">{{ pedido.ciudad }}</td>
      </ng-container>

      <!-- Acciones -->
      <ng-container matColumnDef="acciones">
        <th mat-header-cell *matHeaderCellDef>Acciones</th>
        <td mat-cell *matCellDef="let pedido">
          <button
            mat-icon-button
            color="primary"
            (click)="verPedido(pedido)"
            matTooltip="Ver detalles del pedido"
          >
            <mat-icon>visibility</mat-icon>
          </button>

          <button
            mat-raised-button
            color="primary"
            (click)="guardarEstados(pedido)"
          >
            Guardar
          </button>
        </td>
      </ng-container>

      <!-- Filas -->
      <tr mat-header-row *matHeaderRowDef="columnas"></tr>
      <tr mat-row *matRowDef="let row; columns: columnas;"></tr>
    </table>

    <!-- Paginador -->
    <mat-paginator
      [length]="pedidosFiltrados.length"
      [pageSize]="pageSize"
      [pageSizeOptions]="[5, 10, 20]"
      (page)="onPageChange($event)"
    >
    </mat-paginator>
  </div>

  <!-- Sin pedidos -->
  <ng-template #sinPedidos>
    <p class="texto-vacio">No se encontraron pedidos para este cliente.</p>
  </ng-template>
</mat-card>
